apiVersion: mission-control.flanksource.com/v1
kind: View
metadata:
  name: pod-metric
  namespace: default
  uid: 49faeac7-b90b-4cb9-9db1-7db9d7f463f9
  annotations:
    expected-rows: |
      [
        ["logistics-api-7df4c7f6b7-x9k2m", "Kubernetes::Pod", "Running", "healthy", "missioncontrol", "5", "00000000-0000-0000-0000-000000000000", false],
        ["logistics-ui-6c8f9b4d5e-m7n8p", "Kubernetes::Pod", "Running", "healthy", "missioncontrol", "10", "00000000-0000-0000-0000-000000000000", false]
      ]
    expected-panels: |
      [
        {
          "name": "Pod Health Summary", 
          "type": "number",
          "rows": [
            {"total": 20}
          ]
        }
      ]
spec:
  merge:
    strategy: left
    order: [pod, metrics]
  columns:
    - description: The pod name.
      name: name
      type: string
    - description: The namespace name.
      name: namespace
      type: string
    - description: The status of the deployment.
      name: status
      type: status
    - description: The health of the deployment.
      name: health
      type: health
    - description: The memory usage of the deployment.
      name: memory
      type: string
  queries:
    metrics:
      primaryKey: [pod]
      prometheus:
        connection: connection://mc/prometheus
        query: |
          sum by (namespace, pod) (
            container_memory_usage_bytes{
              namespace="missioncontrol",
              container!="POD", # Skip The pause/infra container
              image!="" # Skip dead containers
            }
          ) / 1024 / 1024
    pod:
      primaryKey: [name]
      configs:
        search: "@order=name"
        tagSelector: namespace in (missioncontrol)
        types:
          - Kubernetes::Pod
  mapping:
    health: pod.health
    memory: >
      pod.config.spec.containers[0].resources.limits.memory + "/" + (has(metrics.value) ? string(metrics.value) : "0")
    name: pod.name
    namespace: pod.tags.namespace
    status: pod.status
  panels:
    - name: "Pod Health Summary"
      type: number
      source: configs
      query:
        aggregates:
          - function: count
            field: "*"
            alias: total
